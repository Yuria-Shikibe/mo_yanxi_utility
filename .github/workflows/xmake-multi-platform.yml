name: Xmake Build

env:
  TARGET_NAME: mo_yanxi.utility
  LLVM_VER: 21

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  build:
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [
          windows-latest,
          ubuntu-latest
        ]
        toolchain: [ msvc, clang, gcc ]
        mode: [ debug, release ]
        include:
          - os: windows-latest
            toolchain: msvc
          - os: windows-latest
            toolchain: clang

          # 2. Linux: 使用 GCC/Clang
#          - os: ubuntu-latest
#            toolchain: gcc
          - os: ubuntu-latest
            toolchain: clang
        exclude:
          - os: windows-latest
            toolchain: gcc
          - os: ubuntu-latest
            toolchain: msvc


    steps:
      - uses: actions/checkout@v4

      - name: Install Libc++ for Clang Modules
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y libc++-dev libc++abi-dev

      # 1. 设置 xmake 环境 (使用最新版)
      - name: Setup xmake
        uses: xmake-io/github-action-setup-xmake@v1
        with:
          xmake-version: latest
          actions-cache-folder: '.xmake-cache'


      - name: Install LLVM  (Linux Clang only)
        if: matrix.os == 'ubuntu-latest' && matrix.toolchain == 'clang'
        run: |
          wget https://apt.llvm.org/llvm.sh
          chmod +x llvm.sh
          sudo ./llvm.sh ${{ env.LLVM_VER }}
          sudo apt-get install -y libc++-${{ env.LLVM_VER }}-dev libc++abi-${{ env.LLVM_VER }}-dev clang-tools-${{ env.LLVM_VER }} libunwind-${{ env.LLVM_VER }}-dev
          echo "/usr/lib/llvm-${{ env.LLVM_VER }}/bin" >> $GITHUB_PATH

      - name: Diagnose Environment
        if: matrix.os == 'ubuntu-latest' && matrix.toolchain == 'clang'
        shell: bash
        run: |
          echo "================ CHECKING CLANG VERSION ================"
          # 检查当前生效的 clang 是哪个
          which clang
          clang --version
          
          echo "================ CHECKING LIBC++ PATHS ================"
          # 关键：询问 Clang 它默认去哪里找头文件
          # 我们显式加上 -stdlib=libc++ 看看它能否找到路径
          echo | clang -v -x c++ -stdlib=libc++ -E -
          
          echo "================ CHECKING INSTALLED FILES ================"
          # 检查 LLVM 21 目录下实际有哪些文件
          # Xmake 寻找 modules 通常需要特定的 .cppm 或 modulemap 文件
          echo "--- Listing LLVM Includes ---"
          ls -F /usr/lib/llvm-${{ env.LLVM_VER }}/include/c++/v1/ || echo "Dir not found"
          
          echo "--- Searching for Module Maps/Sources ---"
          # 查找可能存在的模块定义文件
          find /usr/lib/llvm-${{ env.LLVM_VER }} -name "*.cppm"
          find /usr/lib/llvm-${{ env.LLVM_VER }} -name "module.modulemap"
          
          echo "================ CHECKING PACKAGES ================"
          dpkg -l | grep -E "libc\+\+|clang|llvm"

      # 3. 配置并构建
      # 参数说明:
      # -y: 自动确认
      # -b: 构建
      # -m release: 编译模式 Release
      # --toolchain: 传入矩阵中的编译器 (msvc/gcc/clang)
      - name: Build ${{ matrix.mode }}
        shell: bash
        run: |
          # 定义通用参数变量
          XMAKE_FLAGS="-m ${{ matrix.mode }} --toolchain=${{ matrix.toolchain }}"
          EXTRA_FLAGS=""
          PLAT_FLAGS=""
          
          if [ "${{ matrix.os }}" == "ubuntu-latest" ]; then
             PLAT_FLAGS="-p linux"
          else
             PLAT_FLAGS="-p windows"
          fi
          
          if [[ "${{ matrix.os }}" == "ubuntu-latest" && "${{ matrix.toolchain }}" == "clang" ]]; then
             clang --version
             EXTRA_FLAGS="--sdk=/usr/lib/llvm-${{ env.LLVM_VER }} --cxflags='-stdlib=libc++' --ldflags='-stdlib=libc++'"
          else
             EXTRA_FLAGS=""
          fi
          
          # 执行配置和构建
          # 提示: xmake 支持配置和构建合并在一条命令，或者分两步
          echo "Configuring with: $XMAKE_FLAGS $EXTRA_FLAGS"
          xmake f $XMAKE_FLAGS $PLAT_FLAGS $EXTRA_FLAGS -y
          
          xmake -b -y ${{ env.TARGET_NAME }}

      # 4. 运行测试
      - name: Test
        run: xmake test