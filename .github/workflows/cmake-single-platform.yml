name: Xmake Build

env:
  TARGET_NAME: mo_yanxi.utility

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  build:
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        # 使用 include 显式定义合法的 OS 与 Toolchain 组合
        # 这样自然就排除了 (Windows + gcc) 和 (Linux + msvc)
        include:
          - os: windows-latest
            toolchain: msvc
          - os: windows-latest
            toolchain: clang

          # 2. Linux: 使用 GCC/Clang
          - os: ubuntu-latest
            toolchain: gcc
          - os: ubuntu-latest
            toolchain: clang

    steps:
      - uses: actions/checkout@v4

      - name: Install Libc++ for Clang Modules
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y libc++-dev libc++abi-dev

      # 1. 设置 xmake 环境 (使用最新版)
      - name: Setup xmake
        uses: xmake-io/github-action-setup-xmake@v1
        with:
          xmake-version: latest
          actions-cache-folder: '.xmake-cache'

      # 2. (可选) 确保 Linux 编译器环境准备就绪
      # ubuntu-latest 通常已预装较新的 gcc/clang，xmake 会自动找到它们。
      - name: Prepare Linux Env
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          # 如果需要特定版本，可以在这里 install，例如 sudo apt-get install -y clang-15

      # 3. 配置并构建
      # 参数说明:
      # -y: 自动确认
      # -b: 构建
      # -m release: 编译模式 Release
      # --toolchain: 传入矩阵中的编译器 (msvc/gcc/clang)
      - name: Build Debug
        run: |
          xmake f -m debug
          xmake f --toolchain=${{ matrix.toolchain }}
          xmake -b -y ${{ env.TARGET_NAME }}   

      - name: Build Release
        run: |
          xmake f -m release
          xmake f --toolchain=${{ matrix.toolchain }}
          xmake -b -y ${{ env.TARGET_NAME }}   

      # 4. 运行测试
      - name: Test
        run: xmake test